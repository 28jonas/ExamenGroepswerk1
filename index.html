<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">

	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
	<script  src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.7.8/axios.min.js"></script>

	<script  src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

	<script  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<!--	<script defer src="./script.js"></script>-->
	<link rel="stylesheet" href="./styles.css">

	<title>Countries of the world</title>
</head>
<body>
<div class="d-flex flex-column align-items-center ">
	<h1>Landen van de wereld</h1>
	<div class=""><!--Dit zoekt de landen op-->
		<input type="text" id="countrySearch" class="rounded-pill text-center border-1 border-light-subtle fs-4" placeholder="Type a country:">
	</div>
	
	<div class="select mt-3"> <!--Hiermoeten de continenten in opgezocht worden-->
		<select id="continentSelector" aria-label="Default select example">
		</select>
	</div>
</div>

<div class="container mt-5">
	<div id="countryList" class="row row-cols-1 row-cols-sm-2 row-cols-lg-4 g-3">

	</div>
</div>

<!-- Modal -->
<div class="modal fade" id="countryModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h1 class="modal-title fs-5" id="countryModalLabel">Modal title</h1>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div id="modalinfo" class="modal-body row px-4">
				<div class="col-8">
					<p><strong>Capital: </strong>Kabul</p>
					<p><strong>Languages: </strong>Dari, Pashto, Turkmen</p>
					<p><strong>Currencies: </strong>Afghan afghani (Ø‹)</p>
					<p><strong>Population: </strong>40.218.234</p>
				</div>
				<div class="col-4">
					<img class="img-fluid" src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/5c/Flag_of_the_Taliban.svg/320px-Flag_of_the_Taliban.svg.png" alt="Flag of Afghanistan">
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
			</div>
		</div>
	</div>
</div>

<script>
	const continentSelector = document.getElementById("continentSelector")
	const countrySearch = document.getElementById("countrySearch")
	let countries = [];



	countrySearch.addEventListener("input", () => {
		const filteredCountries = applyFilters();
		setCountries(filteredCountries);
	});
	continentSelector.addEventListener("change", () => {
		const filteredCountries = applyFilters();
		setCountries(filteredCountries);
	});

	async  function getData(){
		try {

			const response = await axios.get('https://restcountries.com/v3.1/all');

			const data = response.data
			console.log(data);
			countries = data
					.sort((a, b) => a.name.common.localeCompare(b.name.common)) // alfabetisch ordenen
					.map(country => ({
						...country,
						population: country.population ? country.population.toLocaleString("nl-BE") : "N/A" // Format population
					}));
			setCountries(countries)
			setContinents([...new Set(data.flatMap(country => country.continents))])
		} catch (error) {
			console.error('Error fetching countries:', error);
		}
	}


	function setContinents(continents){
		continentSelector.innerHTML=`<option value="" selected>Choose a continent</option>`
		continents.forEach(continent => {
			continentSelector.innerHTML+=`<option value="${continent}">${continent}</option>`
		})
	}

	function applyFilters(){

		const searchTerm = countrySearch.value.trim().toLowerCase();

		// Filter countries by name (substring search in a.name.common)
		let filteredCountries = countries.filter(country => country.name.common.toLowerCase().includes(searchTerm));
		// Sort so that countries where the searchTerm is found earlier appear first
		filteredCountries.sort((a, b) => a.name.common.toLowerCase().indexOf(searchTerm) - b.name.common.toLowerCase().indexOf(searchTerm));

		// If the selected continent is empty, show all countries
		filteredCountries = continentSelector.value === ""
				? filteredCountries // No filter, show all countries
				: filteredCountries.filter(country => country.continents.includes(continentSelector.value)); // Filter by selected continent

		return filteredCountries;
	}

	function setCountries(list) {
		const countryListEl = document.getElementById('countryList');
		if (list.length === 0) {
			countryListEl.innerHTML = '<div class="alert alert-info w-50 mx-auto text-center" role="alert">No countries found. Try a different search.</div>';
			return;
		}
		let htmlContent = "";

		// Pre-build all HTML content in one loop
		list.forEach(land => {
			htmlContent += `
        <div class="col">
            <div class="card h-100">
                <img src="${land.flags.png}" class="card-img-top img-fluid" alt="${land.name.common}">
                <div class="card-body">
                    <h5 class="card-title">${land.name.common}</h5>
                    <p class="card-text">Region: ${land.subregion ?? land.region}</p>
                    <p class="card-text">Population: ${land.population}</p>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#countryModal" data-index="${list.indexOf(land)}">
                        Find some more info here
                    </button>
                </div>
            </div>
        </div>`;
		});

		// Insert all the generated HTML at once
		countryListEl.innerHTML = htmlContent;

		// Add event listeners after inserting content
		const buttons = countryListEl.querySelectorAll('button');
		buttons.forEach(button => {
			button.addEventListener("click", (e) => {
				const landIndex = e.target.getAttribute('data-index');
				const land = list[landIndex];
				const modal = document.getElementById('countryModal');
				const languages = Object.values(land.languages ?? {}).join(", ") || "No languages available";
				const currencyArray = Object.values(land.currencies ?? {}).map(c => `${c.name} (${c.symbol})`).join(", ") || "No currencies available";

				modal.querySelector('.modal-title').textContent = `Details of ${land.name.common}`;
				modal.querySelector('.modal-body').innerHTML = `
            <div class="row">
              <div class="col-8">
                <p><strong>Capital: </strong>${land.capital}</p>
                <p><strong>Languages: </strong>${languages}</p>
                <p><strong>Currencies: </strong>${currencyArray}</p>
                <p><strong>Population: </strong>${land.population}</p>
              </div>
              <div class="col-4">
                <img class="img-fluid" src="${land.flags.png}" alt="Flag of ${land.name.common}">
              </div>
            </div>
            <div id="map" style="width: 80%; height: 400px;" class="mx-auto rounded-2 mt-3 shadow-sm"></div>
            `;

				const mapEl = modal.querySelector('.modal-body #map')


				// Check if land.capitalInfo.latlng exists and has valid latitude and longitude
				const latlng = land.capitalInfo && Array.isArray(land.capitalInfo.latlng) && land.capitalInfo.latlng.length === 2
						? land.capitalInfo.latlng
						: [0, 0];  // Fallback to [0, 0] if latlng is invalid

				// Create the map with the corrected coordinates
				const map = L.map('map').setView([latlng[0], latlng[1]], 10);

				L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
					maxZoom: 19,
				}).addTo(map);

				if (latlng[0] !== 0 && latlng[1] !== 0)
					L.marker([latlng[0], latlng[1]]).addTo(map);

				mapEl.classList.add("visually-hidden")

				setTimeout(function() {
					mapEl.classList.remove("visually-hidden")
					map.invalidateSize();
				}, 250);
			});
		});
	}
	getData();
</script>
</body>
</html>